### Auth0 OAuth Authentication Tests for DotnetFastMCP
### Configuration Reference: README.md
### This file tests the complete Auth0 OAuth authentication flow
### 
### Prerequisites:
### 1. Auth0 tenant and application configured
### 2. Environment variables set:
###    - FASTMCP_SERVER_AUTH_AUTH0_DOMAIN
###    - FASTMCP_SERVER_AUTH_AUTH0_CLIENT_ID
###    - FASTMCP_SERVER_AUTH_AUTH0_CLIENT_SECRET
###    - FASTMCP_SERVER_AUTH_AUTH0_AUDIENCE
### 3. DotnetFastMCP server running on http://localhost:5002
### 4. VS Code REST Client extension installed

### ============================================================================
### VARIABLES SECTION
### ============================================================================

### Server Configuration
@baseUrl = http://localhost:5002
@mcpEndpoint = {{baseUrl}}/mcp
@oauthCallbackUrl = {{baseUrl}}/auth/callback

### Auth0 Configuration
@auth0Domain = your-tenant.auth0.com
@clientId = your-auth0-client-id
@clientSecret = your-auth0-client-secret
@audience = https://your-api-identifier
@requiredScopes = openid,profile,email

### Computed URLs
@auth0Authority = https://{{auth0Domain}}
@auth0TokenEndpoint = {{auth0Authority}}/oauth/token
@auth0AuthorizeEndpoint = {{auth0Authority}}/authorize
@auth0UserinfoEndpoint = {{auth0Authority}}/userinfo

### Token Variables
@accessToken =
@refreshToken =
@authorizationCode =
@idToken =

### ============================================================================
### SECTION 1: DISCOVERY ENDPOINTS
### ============================================================================

### 1.1 Get Auth0 OpenID Configuration
GET {{auth0Authority}}/.well-known/openid-configuration
Accept: application/json

### 1.2 Get Auth0 JWKS
GET {{auth0Authority}}/.well-known/jwks.json
Accept: application/json

### 1.3 Get Server OAuth Metadata
GET {{baseUrl}}/.well-known/oauth-authorization-server
Accept: application/json

### ============================================================================
### SECTION 2: PUBLIC ENDPOINTS
### ============================================================================

### 2.1 Test Public Tool
POST {{mcpEndpoint}}
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "method": "GetStatus",
  "params": [],
  "id": 1
}

### ============================================================================
### SECTION 3: PROTECTED ENDPOINTS
### ============================================================================

### 3.1 Try Protected Tool WITHOUT Token (Should Fail)
POST {{mcpEndpoint}}
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "method": "GetUserInfo",
  "params": [],
  "id": 2
}

### 3.2 Get Authenticated User Info (Requires Valid Auth0 Token)
POST {{mcpEndpoint}}
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "jsonrpc": "2.0",
  "method": "GetUserInfo",
  "params": [],
  "id": 3
}

### ============================================================================
### SECTION 4: OAUTH AUTHORIZATION CODE FLOW
### ============================================================================

### 4.1 Step 1 - MANUAL: Get Authorization Code
### Navigate to this URL in your browser
### 
### URL:
 https://{{auth0Domain}}/authorize?
   client_id={{clientId}}&
   response_type=code&
   scope=openid%20profile%20email%20offline_access&
   redirect_uri={{oauthCallbackUrl}}&
   state=random-state-value&
   audience={{audience}}
###
### After authentication, you'll be redirected to:
### {{oauthCallbackUrl}}?code=YOUR_CODE&state=random-state-value
###
### Copy the 'code' parameter from the URL bar

### 4.2 Step 2 - Exchange Authorization Code for Access Token
POST {{auth0TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
client_id={{clientId}}&
client_secret={{clientSecret}}&
code={{authorizationCode}}&
redirect_uri={{oauthCallbackUrl}}&
audience={{audience}}

### 4.3 Step 3 - Refresh Access Token
POST {{auth0TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&
client_id={{clientId}}&
client_secret={{clientSecret}}&
refresh_token={{refreshToken}}

### ============================================================================
### SECTION 5: AUTH0 API INTEGRATION
### ============================================================================

### 5.1 Get User Info from Auth0
GET {{auth0UserinfoEndpoint}}
Authorization: Bearer {{accessToken}}
Accept: application/json

### 5.2 Get User Profile (Management API)
### Note: Requires Management API token with appropriate scopes
GET https://{{auth0Domain}}/api/v2/users/{{userId}}
Authorization: Bearer {{managementApiToken}}
Accept: application/json

### ============================================================================
### SECTION 6: CLIENT CREDENTIALS FLOW (Machine-to-Machine)
### ============================================================================

### 6.1 Get Access Token via Client Credentials
POST {{auth0TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials&
client_id={{clientId}}&
client_secret={{clientSecret}}&
audience={{audience}}

### ============================================================================
### SECTION 7: TOKEN MANAGEMENT
### ============================================================================

### 7.1 Revoke Refresh Token
POST https://{{auth0Domain}}/oauth/revoke
Content-Type: application/x-www-form-urlencoded

client_id={{clientId}}&
client_secret={{clientSecret}}&
token={{refreshToken}}

### ============================================================================
### TESTING WORKFLOW
### ============================================================================
###
### STEP 1: Setup Auth0 Application
### □ Create Auth0 tenant at https://auth0.com
### □ Create new application (Regular Web Application)
### □ Configure Allowed Callback URLs: {{oauthCallbackUrl}}
### □ Configure Allowed Logout URLs
### □ Note: Domain, Client ID, Client Secret
### □ Create API and note the Identifier (audience)
###
### STEP 2: Configure Environment Variables
### □ Set FASTMCP_SERVER_AUTH_AUTH0_DOMAIN
### □ Set FASTMCP_SERVER_AUTH_AUTH0_CLIENT_ID
### □ Set FASTMCP_SERVER_AUTH_AUTH0_CLIENT_SECRET
### □ Set FASTMCP_SERVER_AUTH_AUTH0_AUDIENCE
###
### STEP 3: Execute Tests
### □ Run Section 4.1 - Get Authorization Code
### □ Run Section 4.2 - Exchange for token
### □ Update @accessToken
### □ Run Section 5 - Auth0 API Tests
###
### TROUBLESHOOTING
### • 401 Unauthorized: Token invalid or expired
### • 403 Forbidden: Missing audience or scopes
### • Redirect URI mismatch: Verify in Auth0 Application settings
### • Invalid audience: Ensure API is created and audience matches

### ============================================================================
### END OF AUTH0 OAUTH AUTHENTICATION TESTS
### ============================================================================
