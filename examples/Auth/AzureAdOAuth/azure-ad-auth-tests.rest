### Azure AD OAuth Authentication Tests for DotnetFastMCP
### Configuration Reference: README.md
### This file tests the complete Azure AD authentication flow
### 
### Prerequisites:
### 1. Azure AD app registered in Azure Portal
### 2. Environment variables set as per README.md:
###    - FASTMCP_SERVER_AUTH_AZUREAD_TENANT_ID
###    - FASTMCP_SERVER_AUTH_AZUREAD_CLIENT_ID
###    - FASTMCP_SERVER_AUTH_AZUREAD_CLIENT_SECRET
###    - FASTMCP_SERVER_AUTH_AZUREAD_BASE_AUTHORITY
###    - FASTMCP_SERVER_AUTH_AZUREAD_REQUIRED_SCOPES
### 3. DotnetFastMCP server running on http://localhost:5002
### 4. VS Code REST Client extension installed

### ============================================================================
### VARIABLES SECTION
### Update these variables based on your Azure AD configuration (from README.md)
### ============================================================================

### Server Configuration
@baseUrl = http://localhost:5002
@mcpEndpoint = {{baseUrl}}/mcp
@oauthCallbackUrl = {{baseUrl}}/client-callback

### Azure AD Configuration (from environment variables in README.md)
@tenantId = <Add Tenant Id>
@clientId = <Add client Id>
@clientSecret = <Add client secret>
@baseAuthority = login.microsoftonline.com
@requiredScopes = openid,profile,email,User.Read

### Computed URLs
@azureAuthority = https://{{baseAuthority}}
@azureTokenEndpoint = {{azureAuthority}}/{{tenantId}}/oauth2/v2.0/token
@azureAuthorizeEndpoint = {{azureAuthority}}/{{tenantId}}/oauth2/v2.0/authorize
@graphApiUrl = https://graph.microsoft.com/v1.0

### Token Variables (Populate after obtaining tokens)
@accessToken =<Add Token>
@refreshToken =<Add token>
@authorizationCode =<Add Auth Code`>
@idToken =<Add Token>

### ============================================================================
### SECTION 1: DISCOVERY ENDPOINTS (RFC 8414 & RFC 9728)
### ============================================================================
### These tests verify that the server exposes proper OAuth discovery endpoints
### as mentioned in README.md

### 1.1 Get OAuth Authorization Server Metadata (RFC 8414)
### Expected: Server returns metadata at /.well-known/oauth-authorization-server
GET {{baseUrl}}/.well-known/oauth-authorization-server
Accept: application/json

### 1.2 Get OpenID Connect Configuration
GET {{baseUrl}}/.well-known/openid-configuration
Accept: application/json

### 1.3 Get Protected Resource Metadata (RFC 9728)
GET {{baseUrl}}/mcp/.well-known/protected-resource
Accept: application/json

### 1.4 Get JWKS (JSON Web Key Set)
GET {{baseUrl}}/.well-known/jwks.json
Accept: application/json

### ============================================================================
### SECTION 2: PUBLIC ENDPOINTS (NO AUTHENTICATION REQUIRED)
### ============================================================================
### These tools do not require authentication
### MCP endpoint: {{baseUrl}}/mcp

### 2.1 Test Public Tool - Add Numbers
POST {{mcpEndpoint}}
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "method": "Add",
  "params": [10, 5],
  "id": 1
}

### 2.2 Test Public Tool - Multiply Numbers
POST {{mcpEndpoint}}
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "method": "Multiply",
  "params": [4, 7],
  "id": 2
}

### 2.3 Test Public Tool - Get Server Status
POST {{mcpEndpoint}}
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "method": "GetStatus",
  "params": [],
  "id": 3
}

### 2.4 Test Public Tool - PublicEcho
POST {{mcpEndpoint}}
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "method": "PublicEcho",
  "params": ["Hello unauthenticated request"],
  "id": 4
}

### ============================================================================
### SECTION 3: PROTECTED ENDPOINTS (AUTHENTICATION REQUIRED)
### ============================================================================
### These tests verify that protected tools require valid Azure AD tokens

### 3.1 Try Protected Tool WITHOUT Token (Should Fail with 401)
POST {{mcpEndpoint}}
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "method": "GetUserInfo",
  "params": [],
  "id": 5
}

### 3.2 Try Protected Tool WITH Invalid Token (Should Fail with 401)
POST {{mcpEndpoint}}
Content-Type: application/json
Authorization: Bearer invalid-token-12345

{
  "jsonrpc": "2.0",
  "method": "GetUserInfo",
  "params": [],
  "id": 6
}

### 3.3 Get Authenticated User Info (Requires Valid Azure AD Token)
### Populate @accessToken variable with valid token before running
POST {{mcpEndpoint}}
Content-Type: application/json
Authorization: Bearer {{idToken}}

{
  "jsonrpc": "2.0",
  "method": "GetUserInfo",
  "params": [],
  "id": 7
}

### 3.4 Get User Roles from Azure AD (Requires Valid Azure AD Token)
POST {{mcpEndpoint}}
Content-Type: application/json
Authorization: Bearer {{idToken}}

{
  "jsonrpc": "2.0",
  "method": "GetProviderSpecificInfo",
  "params": [],
  "id": 8
}

### ============================================================================
### SECTION 4: OAUTH AUTHORIZATION CODE FLOW
### ============================================================================
### These tests simulate the OAuth 2.0 Authorization Code flow with Azure AD
### as documented in README.md OAuth flow section

### 4.1 Step 1 - MANUAL: Get Authorization Code
### Navigate to this URL in your browser and authenticate with Azure AD
### Replace {{tenantId}} and {{clientId}} with your actual values from README.md
### 
### URL:
 https://login.microsoftonline.com/c83b22b0-565b-4b46-ac74-550176cf4e54/oauth2/v2.0/authorize?
   client_id=861bccf9-41f8-4507-b486-5e564d917dd0&
   response_type=code&
   scope=openid%20profile%20email%20offline_access%20User.Read&
   redirect_uri=http://localhost:5002/auth/callback&
   state=random-state-value&
   response_mode=query
###
### After successful authentication with Azure AD, you'll be redirected to:
### http://localhost:5002/auth/callback?code=YOUR_CODE&state=random-state-value
###
### Copy the 'code' parameter value and update @authorizationCode variable above

### 4.2 Step 2 - Exchange Authorization Code for Access Token
### Uses Azure AD token endpoint with configuration from README.md
POST {{azureTokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
client_id={{clientId}}&
client_secret={{clientSecret}}&
code={{authorizationCode}}&
redirect_uri=http://localhost:5002/auth/callback&
scope=openid%20profile%20email%20offline_access%20User.Read

### 4.3 Step 3 - Refresh Access Token (Using Refresh Token)
### Once you have a refresh token from Step 2, use it here
POST {{azureTokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&
client_id={{clientId}}&
client_secret={{clientSecret}}&
refresh_token={{refreshToken}}&
scope=openid%20profile%20email%20User.Read

### 4.4 Step 4 - Decode ID Token at jwt.io
### After obtaining token in Step 2, copy the id_token value
### Visit https://jwt.io and paste the id_token in the Encoded field
### This shows the user identity claims from Azure AD

### ============================================================================
### SECTION 5: OAUTH PROXY ENDPOINTS
### ============================================================================
### The OAuth Proxy handles authorization and token exchange
### as mentioned in README.md: "The OAuth Proxy handles: DCR, Authorization code flow with PKCE"

### 5.1 Discover OAuth Proxy Endpoints
GET {{baseUrl}}/.well-known/oauth-authorization-server
Accept: application/json

### 5.2 Proxy Authorization Request
### Initiates authorization with Azure AD through the proxy
# @no-redirect
GET {{baseUrl}}/oauth/authorize?client_id={{clientId}}&response_type=code&scope=openid%20profile%20email%20offline_access&redirect_uri={{oauthCallbackUrl}}&state=random-state-value
Accept: application/json

### 5.3 Proxy Token Exchange
### Exchange authorization code for token through the proxy
# @name proxyTokenExchange
POST {{baseUrl}}/oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&code={{authorizationCode}}&redirect_uri={{oauthCallbackUrl}}

### 5.4 Proxy Userinfo Endpoint
### Get authenticated user information from the proxy
GET {{baseUrl}}/oauth/userinfo
Authorization: Bearer {{proxyTokenExchange.response.body.id_token}}
Accept: application/json

### 5.5 Proxy Token Revocation
POST {{baseUrl}}/oauth/revoke
Content-Type: application/x-www-form-urlencoded

token={{accessToken}}&
token_type_hint=access_token

### ============================================================================
### SECTION 6: DYNAMIC CLIENT REGISTRATION (DCR)
### ============================================================================
### As mentioned in README.md: "OAuth Proxy handles: Dynamic Client Registration (DCR)"
### Test the OAuth 2.0 Dynamic Client Registration Protocol (RFC 7591)

### 6.1 Register New OAuth Client via DCR
POST {{baseUrl}}/oauth/register
Content-Type: application/json

{
  "client_name": "DotnetFastMCP Test Client",
  "description": "Test client for Azure AD OAuth with FastMCP",
  "redirect_uris": [
    "http://localhost:5002/auth/callback"
  ],
  "grant_types": [
    "authorization_code",
    "refresh_token"
  ],
  "response_types": [
    "code"
  ],
  "scope": "openid profile email",
  "token_endpoint_auth_method": "client_secret_basic",
  "client_uri": "http://localhost:5002",
  "contacts": [
    "admin@example.com"
  ]
}

### 6.2 Register Confidential Client (PKCE Support)
### As mentioned in README.md: "Authorization code flow with PKCE"
POST {{baseUrl}}/oauth/register
Content-Type: application/json

{
  "client_name": "FastMCP PKCE Client",
  "redirect_uris": ["http://localhost:5002/auth/callback"],
  "grant_types": ["authorization_code"],
  "response_types": ["code"],
  "scope": "openid profile email",
  "token_endpoint_auth_method": "none",
  "require_pkce": true
}

### ============================================================================
### SECTION 7: AZURE GRAPH API INTEGRATION
### ============================================================================
### These tests show integration with Microsoft Graph API using the access token
### Graph API requires valid Azure AD access token with appropriate scopes

### 7.1 Get Current User Profile
### Requires scope: User.Read or profile
GET {{graphApiUrl}}/me
Authorization: Bearer {{accessToken}}
Accept: application/json

### 7.2 Get Current User's Email and UPN
GET {{graphApiUrl}}/me?$select=mail,userPrincipalName
Authorization: Bearer {{accessToken}}
Accept: application/json

### 7.3 Get Current User's Photo
### Note: May return 404 if user has no photo
GET {{graphApiUrl}}/me/photo/$value
Authorization: Bearer {{accessToken}}

### 7.4 Get User's Manager
GET {{graphApiUrl}}/me/manager
Authorization: Bearer {{accessToken}}
Accept: application/json

### 7.5 Get User's Group Memberships
GET {{graphApiUrl}}/me/memberOf
Authorization: Bearer {{accessToken}}
Accept: application/json

### ============================================================================
### SECTION 8: SECURITY & RATE LIMITING TESTS
### ============================================================================
### Test rate limiting, CORS, and other security features
### as implemented in FastMCP server

### 8.1 Test Rate Limiting - Token Endpoint Request
### NOTE: May be rate limited depending on server configuration
POST {{baseUrl}}/oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&refresh_token=invalid-refresh-token

### 8.2 Test Rate Limiting - Rapid Requests (Run multiple times)
### After 10 requests in 1 minute to /oauth/token, expect 429 Too Many Requests
POST {{baseUrl}}/oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&username=user@example.com&password=invalid

### 8.3 Test CORS Preflight Request
### Verifies CORS is configured to allow cross-origin requests
OPTIONS {{mcpEndpoint}}
Origin: http://localhost:3000
Access-Control-Request-Method: POST
Access-Control-Request-Headers: content-type, authorization

### 8.4 Test CORS with Actual Request
POST {{mcpEndpoint}}
Origin: http://localhost:5002
Access-Control-Request-Credentials: true
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "method": "GetStatus",
  "params": [],
  "id": 8
}

### 8.5 Test Invalid Content-Type
POST {{mcpEndpoint}}
Content-Type: text/plain

This is invalid JSON

### 8.6 Test Missing Content-Type Header
POST {{mcpEndpoint}}

{
  "jsonrpc": "2.0",
  "method": "GetStatus",
  "params": [],
  "id": 9
}

### ============================================================================
### SECTION 9: ADVANCED SCENARIOS
### ============================================================================
### Test advanced authentication and authorization scenarios

### 9.1 Test with Multiple Scopes
### Exchange code with additional scopes beyond openid, profile, email
POST {{azureTokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
client_id={{clientId}}&
client_secret={{clientSecret}}&
code={{authorizationCode}}&
redirect_uri=http://localhost:5002/auth/callback&
scope=openid%20profile%20email%20user.read

### 9.2 Test Incremental Consent
### Request additional scopes using refresh token
POST {{azureTokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&
client_id={{clientId}}&
client_secret={{clientSecret}}&
refresh_token={{refreshToken}}&
scope=openid%20profile%20email%20calendar.read

### 9.3 Test Batch Operations
### Call multiple tools in single batch request
POST {{mcpEndpoint}}
Content-Type: application/json
Authorization: Bearer {{accessToken}}

[
  {
    "jsonrpc": "2.0",
    "method": "Add",
    "params": [10, 5],
    "id": 10
  },
  {
    "jsonrpc": "2.0",
    "method": "Multiply",
    "params": [4, 7],
    "id": 11
  },
  {
    "jsonrpc": "2.0",
    "method": "GetUserInfo",
    "params": [],
    "id": 12
  }
]

### 9.4 Test Token Introspection
### Verify token is still valid and get its metadata
POST {{baseUrl}}/oauth/token/introspect
Content-Type: application/x-www-form-urlencoded

token={{accessToken}}&
token_type_hint=access_token

### ============================================================================
### SECTION 10: CONFIGURATION REFERENCE FROM README.md
### ============================================================================
###
### Azure App Registration Configuration:
### ✓ Name: Your app name (from Azure Portal)
### ✓ Supported account types: Choose based on your needs
### ✓ Redirect URI: http://localhost:5002/auth/callback (CRITICAL - matches @oauthCallbackUrl)
###
### Environment Variables to Set (from README.md):
### Windows PowerShell:
###   $env:FASTMCP_SERVER_AUTH_AZUREAD_TENANT_ID="your-tenant-id"
###   $env:FASTMCP_SERVER_AUTH_AZUREAD_CLIENT_ID="your-client-id"
###   $env:FASTMCP_SERVER_AUTH_AZUREAD_CLIENT_SECRET="your-client-secret"
###   $env:FASTMCP_SERVER_AUTH_AZUREAD_BASE_AUTHORITY="login.microsoftonline.com"
###   $env:FASTMCP_SERVER_AUTH_AZUREAD_REQUIRED_SCOPES="openid,profile,email"
###
### Linux/Mac:
###   export FASTMCP_SERVER_AUTH_AZUREAD_TENANT_ID="your-tenant-id"
###   export FASTMCP_SERVER_AUTH_AZUREAD_CLIENT_ID="your-client-id"
###   export FASTMCP_SERVER_AUTH_AZUREAD_CLIENT_SECRET="your-client-secret"
###   export FASTMCP_SERVER_AUTH_AZUREAD_BASE_AUTHORITY="login.microsoftonline.com"
###   export FASTMCP_SERVER_AUTH_AZUREAD_REQUIRED_SCOPES="openid,profile,email"
###
### Server Endpoints (from README.md):
### ✓ MCP endpoint: http://localhost:5002/mcp
### ✓ OAuth callback: http://localhost:5002/auth/callback
### ✓ OAuth discovery: http://localhost:5002/.well-known/oauth-authorization-server
###
### OAuth Proxy Capabilities (from README.md):
### ✓ Dynamic Client Registration (DCR)
### ✓ Authorization code flow with PKCE
### ✓ Token exchange and validation

### ============================================================================
### TESTING WORKFLOW
### ============================================================================
###
### STEP 1: Setup Azure AD Application
### □ Register app in Azure Portal
### □ Set Redirect URI to: http://localhost:5002/auth/callback
### □ Create client secret
### □ Note: Tenant ID, Client ID, Client Secret
###
### STEP 2: Configure Environment Variables
### □ Set FASTMCP_SERVER_AUTH_AZUREAD_TENANT_ID
### □ Set FASTMCP_SERVER_AUTH_AZUREAD_CLIENT_ID
### □ Set FASTMCP_SERVER_AUTH_AZUREAD_CLIENT_SECRET
### □ Set FASTMCP_SERVER_AUTH_AZUREAD_BASE_AUTHORITY
### □ Set FASTMCP_SERVER_AUTH_AZUREAD_REQUIRED_SCOPES
###
### STEP 3: Start the Server
### □ Run: dotnet run from examples/Auth/AzureAdOAuth
### □ Verify: Server starts on http://localhost:5002
###
### STEP 4: Update REST Client Variables
### □ Update @tenantId with your Tenant ID
### □ Update @clientId with your Client ID
### □ Update @clientSecret with your Client Secret
### □ Verify @oauthCallbackUrl = http://localhost:5002/client-callback
###
### STEP 5: Execute Tests in Order
### □ Run Section 1 - Discovery Endpoints (No auth needed)
### □ Run Section 2 - Public Tools (No auth needed)
### □ Run Section 3.1-3.2 - Protected Tools without token (Should fail)
### □ Run Section 4 - Get Authorization Code (Manual browser step)
### □ Run Section 4.2 - Exchange code for token (Get @accessToken)
### □ Update @accessToken variable with obtained token
### □ Run Section 3.3-3.4 - Protected Tools with token (Should succeed)
### □ Run Section 5 - OAuth Proxy Tests
### □ Run Section 6 - DCR Tests
### □ Run Section 7 - Graph API Tests
### □ Run Section 8 - Security Tests
### □ Run Section 9 - Advanced Tests
###
### EXPECTED RESULTS
### ✅ Discovery endpoints return 200 with proper metadata
### ✅ Public tools return correct results without auth
### ✅ Protected tools return 401 without valid token
### ✅ Authorization code flow successfully obtains token
### ✅ Protected tools return user data with valid token
### ✅ DCR successfully registers new clients
### ✅ Rate limiting returns 429 after threshold
### ✅ CORS headers present in responses
### ✅ Microsoft Graph API calls work with valid token
###
### TROUBLESHOOTING
### • 401 Unauthorized: Token expired or invalid format
###   → Get new token from Section 4.2
### • 403 Forbidden: User lacks required Azure AD permissions
###   → Check scopes and app roles in Azure Portal
### • 429 Too Many Requests: Rate limit exceeded
###   → Wait 1 minute before retry
### • CORS error: Cross-origin request blocked
###   → Verify CORS is enabled in server
### • INVALID_SCOPE: Scope not authorized in Azure AD app
###   → Add scope to Azure Portal app API permissions
### • Redirect URI mismatch: Must be http://localhost:5002/auth/callback
###   → Verify in Azure Portal App Registration

### ============================================================================
### END OF AZURE AD AUTHENTICATION TESTS
### ============================================================================